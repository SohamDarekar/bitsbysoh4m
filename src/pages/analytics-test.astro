---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Analytics Test Page" forceGA={true}>
  <div class="max-w-3xl mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">Google Analytics Test Page</h1>
    
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Testing Methods:</h2>
      
      <div class="space-y-4">
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">1. Check GA Status:</h3>
          <p id="ga-status" class="text-sm font-mono mt-1">Checking GA status...</p>
          <button 
            id="check-ga-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Refresh Status
          </button>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">2. Console Output:</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
            Open browser console (F12 > Console) to see detailed logs
          </p>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">3. Send Test Event:</h3>
          <button 
            id="test-event-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Send Test Event
          </button>
          <p id="event-result" class="text-sm font-mono mt-2"></p>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">4. Network Requests:</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
            Check Network tab for requests to googletagmanager.com
          </p>
          <button 
            id="show-cookies-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Show GA Cookies
          </button>
          <div id="cookies-info" class="text-sm font-mono mt-2 p-2 bg-gray-100 dark:bg-gray-700 rounded hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Function to check GA status
    function checkGAStatus() {
      const statusEl = document.getElementById('ga-status');
      
      console.log("Checking for Google Analytics availability...");
      
      if (window.gaInitialized && typeof window.gtag === 'function') {
        statusEl.textContent = '‚úÖ Google Analytics properly initialized and ready';
        statusEl.className = 'text-sm font-mono mt-1 text-green-600 dark:text-green-400';
        return true;
      } else if (typeof window.gtag === 'function') {
        statusEl.textContent = 'üü° Google Analytics partially initialized (gtag found)';
        statusEl.className = 'text-sm font-mono mt-1 text-yellow-600 dark:text-yellow-400';
        return true;
      } else if (window.dataLayer) {
        statusEl.textContent = 'üü° Google Analytics partially loaded (dataLayer found)';
        statusEl.className = 'text-sm font-mono mt-1 text-yellow-600 dark:text-yellow-400';
        return false;
      } else {
        statusEl.textContent = '‚ùå Google Analytics not detected';
        statusEl.className = 'text-sm font-mono mt-1 text-red-600 dark:text-red-400';
        return false;
      }
    }

    // Function to show cookies
    function showGACookies() {
      const cookiesEl = document.getElementById('cookies-info');
      cookiesEl.classList.remove('hidden');
      
      const allCookies = document.cookie.split(';');
      const gaCookies = allCookies.filter(cookie => 
        cookie.trim().startsWith('_ga') || 
        cookie.trim().startsWith('_gid')
      );
      
      if (gaCookies.length > 0) {
        cookiesEl.innerHTML = '<strong>GA Cookies Found:</strong><br>' +
          gaCookies.map(c => `- ${c.trim()}`).join('<br>');
      } else {
        cookiesEl.innerHTML = '<strong>No GA Cookies Found</strong><br>This is expected in development or if cookies are blocked.';
      }
    }

    // Helper function to safely send GA events without overwriting cookies
    function sendSafeGAEvent(eventName, params) {
      if (typeof window.gtag !== 'function') {
        return false;
      }
      
      try {
        // Use send_to parameter to avoid reconfiguring the tracker
        const fullParams = {
          ...params,
          non_interaction: true,  // Won't affect bounce rate
          send_to: 'G-P300W8XW2P' // Explicitly specify measurement ID
        };
        
        // Send as event only, not as config which would reset cookies
        window.gtag('event', eventName, fullParams);
        return true;
      } catch (error) {
        console.error('Error sending GA event:', error);
        return false;
      }
    }

    // Wait for page to load
    window.addEventListener('load', function() {
      // Initial check
      setTimeout(checkGAStatus, 1000);
      
      // Set up button event handlers
      document.getElementById('check-ga-button').addEventListener('click', checkGAStatus);
      
      document.getElementById('test-event-button').addEventListener('click', function() {
        const resultEl = document.getElementById('event-result');
        
        // Generate random ID for this test event
        const testId = Math.floor(Math.random() * 1000000);
        
        const success = sendSafeGAEvent('test_event', {
          'event_category': 'testing',
          'event_label': `Test event ${testId}`
        });
        
        if (success) {
          resultEl.textContent = `‚úÖ Test event ${testId} sent`;
          resultEl.className = 'text-sm font-mono mt-2 text-green-600 dark:text-green-400';
          console.log(`Test event ${testId} sent to Google Analytics`);
        } else {
          resultEl.textContent = '‚ùå Failed: gtag function not available';
          resultEl.className = 'text-sm font-mono mt-2 text-red-600 dark:text-red-400';
        }
      });
      
      document.getElementById('show-cookies-button').addEventListener('click', showGACookies);
    });
  </script>
</BaseLayout>
