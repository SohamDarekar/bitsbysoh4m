---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Analytics Test Page" forceGA={true}>
  <div class="max-w-3xl mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">Google Analytics Test Page</h1>
    
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Testing Methods:</h2>
      
      <div class="space-y-4">
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">1. Check GA Status:</h3>
          <p id="ga-status" class="text-sm font-mono mt-1">Checking GA status...</p>
          <button 
            id="check-ga-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Refresh Status
          </button>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">2. Console Output:</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
            Open browser console (F12 > Console) to see detailed logs
          </p>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">3. Send Test Event:</h3>
          <button 
            id="test-event-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Send Test Event
          </button>
          <p id="event-result" class="text-sm font-mono mt-2"></p>
        </div>
        
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <h3 class="font-medium">4. Network Requests:</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
            Check Network tab for requests to googletagmanager.com
          </p>
          <button 
            id="show-cookies-button"
            class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition duration-200"
          >
            Show GA Cookies
          </button>
          <div id="cookies-info" class="text-sm font-mono mt-2 p-2 bg-gray-100 dark:bg-gray-700 rounded hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { isGAInitialized, sendGAEvent, whenGAReady } from '../scripts/analytics-helper.js';

    // Function to check GA status
    function checkGAStatus() {
      const statusEl = document.getElementById('ga-status');
      
      console.log("Checking for Google Analytics availability...");
      console.log("Current hostname:", window.location.hostname);
      
      if (isGAInitialized()) {
        statusEl.textContent = 'âœ… Google Analytics properly initialized and ready';
        statusEl.className = 'text-sm font-mono mt-1 text-green-600 dark:text-green-400';
        return true;
      } else if (typeof window.gtag === 'function') {
        statusEl.textContent = 'ðŸŸ¡ Google Analytics partially initialized (gtag found)';
        statusEl.className = 'text-sm font-mono mt-1 text-yellow-600 dark:text-yellow-400';
        return true;
      } else if (window.dataLayer) {
        statusEl.textContent = 'ðŸŸ¡ Google Analytics partially loaded (dataLayer found)';
        statusEl.className = 'text-sm font-mono mt-1 text-yellow-600 dark:text-yellow-400';
        return false;
      } else {
        statusEl.textContent = 'âŒ Google Analytics not detected';
        statusEl.className = 'text-sm font-mono mt-1 text-red-600 dark:text-red-400';
        return false;
      }
    }

    // Function to show cookies with domain information
    function showGACookies() {
      const cookiesEl = document.getElementById('cookies-info');
      cookiesEl.classList.remove('hidden');
      
      const allCookies = document.cookie.split(';');
      const gaCookies = allCookies.filter(cookie => 
        cookie.trim().startsWith('_ga') || 
        cookie.trim().startsWith('_gid')
      );
      
      const domainInfo = `<strong>Current Domain:</strong> ${window.location.hostname}<br>`;
      
      if (gaCookies.length > 0) {
        cookiesEl.innerHTML = domainInfo + 
          '<strong>GA Cookies Found:</strong><br>' +
          gaCookies.map(c => `- ${c.trim()}`).join('<br>');
      } else {
        cookiesEl.innerHTML = domainInfo + 
          '<strong>No GA Cookies Found</strong><br>This may indicate a domain/cookie issue or cookies are blocked.';
      }
    }

    // Wait for page to load
    window.addEventListener('load', function() {
      // Initial check with a delay
      setTimeout(checkGAStatus, 1000);
      
      // Set up button event handlers
      document.getElementById('check-ga-button').addEventListener('click', checkGAStatus);
      
      document.getElementById('test-event-button').addEventListener('click', function() {
        const resultEl = document.getElementById('event-result');
        
        // Generate random ID for this test event
        const testId = Math.floor(Math.random() * 1000000);
        
        const success = sendGAEvent('test_event', {
          'event_category': 'testing',
          'event_label': `Test event ${testId}`
        });
        
        if (success) {
          resultEl.textContent = `âœ… Test event ${testId} sent`;
          resultEl.className = 'text-sm font-mono mt-2 text-green-600 dark:text-green-400';
          console.log(`Test event ${testId} sent to Google Analytics`);
        } else {
          resultEl.textContent = 'âŒ Failed: gtag function not available';
          resultEl.className = 'text-sm font-mono mt-2 text-red-600 dark:text-red-400';
        }
      });
      
      document.getElementById('show-cookies-button').addEventListener('click', showGACookies);
      
      // Register for GA ready events
      whenGAReady(() => {
        console.log("Google Analytics is now fully initialized and ready to use");
        checkGAStatus();
      });
    });
    
    // All GA events are sent using sendGAEvent, which only uses 'event' calls.
    // Never call gtag('config', ...) here to avoid cookie warnings.
  </script>
</BaseLayout>
